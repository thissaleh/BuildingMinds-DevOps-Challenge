helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
helm install prometheus prometheus-community/prometheus -f prometheus-values.yaml --namespace default

helm repo add grafana https://grafana.github.io/helm-charts
helm repo update
helm install grafana grafana/grafana --namespace default


# prometheus-values.yaml
server:
  global:
    scrape_interval: 15s
  scrape_configs:
    - job_name: "kafka-jmx-exporter"
      kubernetes_sd_configs:
        - role: pod
      relabel_configs:
        - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_pod_label_app]
          action: keep
          regex: default;kafka # Assuming 'app' label is 'kafka' and namespace is 'default'
        - source_labels: [__meta_kubernetes_pod_container_port_name]
          action: keep
          regex: jmx # Matches container with JMX exporter enabled on port 556
      metrics_path: /metrics
      scheme: http


helm install prometheus prometheus-community/prometheus -f prometheus-values.yaml --namespace default




#service-monitor.yml

apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: kafka-jmx
  namespace: default
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: kafka
  endpoints:
    - port: metrics
      path: /metrics
      interval: 15s

#service.yml
apiVersion: v1
kind: Service
metadata:
  name: kafka-jmx-metrics
  namespace: default  # Ensure this matches your Kafka namespace
  labels:
    app.kubernetes.io/name: kafka
spec:
  ports:
    - name: metrics
      port: 5556
      targetPort: 5556
  selector:
    app.kubernetes.io/name: kafka
